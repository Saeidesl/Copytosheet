<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ú©Ø³Ù„</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #f9f9f9;
      direction: rtl;
    }

    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    label, input, select, button {
      font-size: 1rem;
      margin: 0.5rem 0;
    }

    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .row select {
      flex: 1;
    }

    .row button {
      font-size: 1rem;
      padding: 0.3rem 0.6rem;
    }

    #mappings {
      margin-bottom: 1rem;
    }

    button {
      background: #008CBA;
      color: white;
      border: none;
      padding: 0.6rem;
      border-radius: 6px;
      width: 100%;
    }

    button:active {
      transform: scale(0.98);
    }

    input[type="file"] {
      width: 100%;
      padding: 0.5rem;
    }

    .msg {
      text-align: center;
      margin-top: 1rem;
      color: green;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„</h1>
    <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <div id="mappings"></div>
    <button onclick="addMapping()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯</button>
    <button onclick="submitData()">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
    <div class="msg" id="message"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let mappings = [];

    function addMapping(from = '', to = '') {
      const div = document.createElement('div');
      div.className = "row";
      div.innerHTML = `
        <select class="from">
          ${getColumnOptions(from)}
        </select>
        <select class="to">
          ${getColumnOptions(to)}
        </select>
        <button onclick="this.parentNode.remove()">âŒ</button>
      `;
      document.getElementById("mappings").appendChild(div);
    }

    function getColumnOptions(selected = '') {
      const letters = [...Array(26)].map((_, i) => String.fromCharCode(65 + i));
      return letters.map(letter =>
        `<option value="${letter}" ${selected === letter ? "selected" : ""}>${letter}</option>`
      ).join('');
    }

    function submitData() {
      const fileInput = document.getElementById("excelFile");
      const file = fileInput.files[0];
      if (!file) return showMessage("ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯", true);

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: "A", range: 1 }); // Ø§Ø² Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ… Ø´Ø±ÙˆØ¹ Ú©Ù†

        const records = {};
        document.querySelectorAll("#mappings .row").forEach(row => {
          const from = row.querySelector(".from").value;
          const to = row.querySelector(".to").value;
          const values = json.map(row => [row[from] || ""]);
          if (!records[to]) records[to] = [];
          records[to] = records[to].concat(values);
        });

        sendToServer(records);
      };
      reader.readAsArrayBuffer(file);
    }

    function sendToServer(records) {
      fetch("https://script.google.com/macros/s/AKfycbwDhqStNuEON7HeCCnG_OxTIDrLQQD8xFbBY6YfBID43h81BxsUtYfZ6snmMWFfjyhrfw/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ records }),
      })
        .then(res => res.text())
        .then(msg => showMessage(msg))
        .catch(err => showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§", true));
    }

    function showMessage(msg, isError = false) {
      const el = document.getElementById("message");
      el.textContent = msg;
      el.className = "msg" + (isError ? " error" : "");
    }

    // Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø±Ø¯ÛŒÙ Ù…Ù¾ÛŒÙ†Ú¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    window.onload = () => addMapping();
  </script>
</body>
</html>
